# 高级标点工具箱 AdvWm

本文受众为希望使用触发器自定义标点的触发器开发者。如果你是触发器的普通用户，无需查看本文。  

## 需求

- FF14
- 与 FF14 版本匹配的 Advanced Combat Tracker （ACT）
- Triggernometry 高级触发器
- [PostNamazu 鲶鱼精邮差](https://github.com/Natsukage/PostNamazu)

## 简介

高级标点工具箱是一组 Triggernometry 触发器。

相比鲶鱼精邮差原本使用的 JSON 文本指令，它接收一串人类更加易懂、易输入的文本，将其处理成鲶鱼精邮差预期的 JSON 指令并标点。

本工具在触发器用户与鲶鱼精邮差之间充当桥梁，显著简化开发触发器时调用场地标点的操作。

下面展示了两个简单的例子：

- 例 1：将场地标点 `1` 标记在场地正中心 （假设为 `100, 100, 0`）、同时清除标点 `2`

  - 鲶鱼精邮差 JSON 文本指令：

    ```json
    {
      "One":   {"X": 100, "Z": 100, "Y": 0, "Active": true}
      "Two":   {"Active": false}
    }
    ```

  - 高级标点工具箱文本指令：

    ```python
    1: 100, 100, 0
    2: clear
    ```

- 例 2：场地八方标点，半径约 `10√2` = `14.14`

  - 鲶鱼精邮差 JSON 文本指令：

    ```json
    {
      "A":   {"X": 100, "Z": 85.86,  "Y": 0, "Active": true},  
      "B":   {"X": 114.14, "Z": 100, "Y": 0, "Active": true},  
      "C":   {"X": 100, "Z": 114.14, "Y": 0, "Active": true},   
      "D":   {"X": 85.86,  "Z": 100, "Y": 0, "Active": true},   
      "One":    {"X": 110, "Z": 90,  "Y": 0, "Active": true},   
      "Two":    {"X": 110, "Z": 110, "Y": 0, "Active": true},   
      "Three":  {"X": 90,  "Z": 110, "Y": 0, "Active": true},  
      "Four":   {"X": 90,  "Z": 90,  "Y": 0, "Active": true}
    }
    ```

  - 高级标点工具箱文本指令：

    ```python
    action:   circle
    center:   100, 100, 0
    r:        10√2
    waymarks: A4D3C2B1
    ```
    
由此可以明显看出二者的差异。

用户仅需接近自然语言的输入，无需手动输入 JSON 字符串，也无需在 Triggernometry 或 cactbot 等脚本代码中构建标点数据结构并序列化。

其代价仅是额外的一点字符串处理和数学计算，对于现代计算机的性能而言微不足道。

## 调用方式

在触发器中新建动作，选择 “具名回调”，如下图：

<img src="https://github.com/user-attachments/assets/18fcec85-37ba-4594-a9d9-9fe18e3ef9ea" height="200">

目前所有回调名称均为 `AdvWm`，仅回调参数有所不同。

下文中会省略类似的截图，直接给出相应的参数文本，如 `A: 100, 90, 0`。

如果你要输入多行参数，可以点击左侧的小三角展开文本框。

## 背景知识

### 坐标系

高级标点工具箱支持直角坐标系与极（柱）坐标系，二者的坐标与方向角定义均与 FF14 解析插件一致。

故使用本工具前需要先了解 FF14 中的坐标系定义及触发器中的相关数学函数。

请阅读[坐标系与角度](https://github.com/MnFeN/ACT_Tech_Guide/blob/main/Triggernometry%20%E8%A7%A6%E5%8F%91%E5%99%A8%E5%86%99%E4%BD%9C%E6%8C%87%E5%8D%97/%E5%9D%90%E6%A0%87%E7%B3%BB%E4%B8%8E%E8%A7%92%E5%BA%A6.md)，尤其是与角度有关的函数，对标点时计算角度有很大帮助。

### 表示坐标

你可以任意使用直角坐标系或极（柱）坐标系表示坐标。

如下表，位于 (10, 10√3, 0) 处的 A 点可以用以下两种方式表示。

如果你无法理解下表，或有任何疑问，请务必阅读前面的链接 “坐标系与角度” 。

|     |直角坐标系|极（柱）坐标系|
|:---:|:---:|:---:|
|**格式**|`x, y, z`|`polar r, θ, z`|
|**图示**|<img src="https://github.com/user-attachments/assets/c80126dc-64c1-49a8-8e46-609fa931b449" height="300">|<img src="https://github.com/user-attachments/assets/17d5a528-c174-4502-b5e0-9f7fc77f1391" height="300">|
|**参数**|`A: 10, 10√3, 0`|`A: polar 20, 30°, 0` 或 <br /> `A: polar 20, π/6, 0`|

此外你应该会注意到，坐标中可以直接插入 `π` `°` `√` 等数学符号。

这也是高级标点工具箱的特性，允许你在参数部分直接输入数学公式，并调用触发器中的任何数学函数。

> 注：如果坐标部分包含多参数的函数，目前的程序会无法正确识别参数中的逗号，如：
>
> `A: 10, round(12.34, 1), 0`
>
> 此时可以将这部分用数值表达式括起来，使触发器预先计算，如：
>
> `A: 10, ${n: round(12.34, 1)}, 0`
>
> 预计会更新修复此问题。

## 基础标点模式：默认关键字

鲶鱼精邮差的 `place` 标点动作提供了一系列非 JSON 的默认关键字。

高级标点工具箱也可以接收同样的关键字并转发消息，所以你可以完全使用回调名 `AdvWm` 代替 `place`。

默认关键字如下：

| 参数（关键字）             | 描述                                 |
|:---:|---|
| **`save`**<br />**`backup`** | 储存当前的场地标点至缓存。|
| **`load`**<br />**`restore`** | 应用当前缓存的标点为本地标点。|
| **`reset`**      | 清除缓存的场地标点。|
| **`clear`**      | 清除当前所有本地标点。|
| **`public`**     | 非战斗状态下，将本地标点公开标记。|

<img src="https://github.com/user-attachments/assets/9274d35a-8564-49eb-b8e4-718df03c272b" height="60">

下文所述的 “回调参数” 均是这样填进上图的第二栏，不再截图赘述。

### 传入参数

在介绍下文的高级工具箱特有的标典模式前，先介绍一下传入文本参数的格式。

触发器首先会将文本中的所有 `${...}` 解析替换为实际值，然后传入高级标点触发器。

随后，这段文本会按行分割，空白行和 `//` 开头的注释行会被忽略。

剩余行中，每行的格式应为：`某参数名: 某参数值`，如前文中的例子：

    ```python
    action:   circle
    center:   100, 100, 0
    r:        10√2
    waymarks: A4D3C2B1
    ```

根据不同标点模式，程序会预期一系列不同的参数名，详见下文。

### 标点模式：正常模式

### 标点模式：圆周模式 (circle)

### 标点模式：圆弧模式 (arc)

### 标点模式：线性插值 (linearconnect)
